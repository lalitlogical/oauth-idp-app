# Install below plugin first before using helmfile apply --debug
# helm plugin install https://github.com/databus23/helm-diff

# Useful commands
# helmfile -l name=oauth-idp apply -f helm/helmfile.yaml 
# helmfile -l name=oauth-client apply -f helm/helmfile.yaml
# helmfile -l name=oauth-client-kafka apply -f helm/helmfile.yaml

# Restart services
# kubectl rollout restart deployment oauth-idp-app -n oauth-apps
# kubectl rollout restart deployment oauth-client-app -n oauth-apps
# kubectl rollout restart deployment oauth-client-kafka-app -n oauth-apps

repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  # - name: ingress-nginx
  #   url: https://kubernetes.github.io/ingress-nginx
  - name: traefik
    url: https://traefik.github.io/charts

releases:
  # - name: ingress-nginx
  #   namespace: ingress-nginx
  #   chart: ingress-nginx/ingress-nginx
  #   version: 4.12.2
  #   values:
  #     - controller:
  #         minReadySeconds: 10
  #         progressDeadlineSeconds: 60
  
  - name: traefik
    namespace: traefik
    createNamespace: true
    chart: traefik/traefik
    values:
      - dashboard:
          enabled: true
        api:
          dashboard: true
        ingressClass:
          enabled: true
          isDefaultClass: true
          name: traefik
        entryPoints:
          web:
            address: ":80"
          websecure:
            address: ":443"

  - name: postgresql
    namespace: services
    chart: bitnami/postgresql
    version: 16.7.4
    values:
      - auth:
          username: postgres
          password: postgres
          database: oauth_client_development
        primary:
          persistence:
            enabled: true
            size: 8Gi
          service:
            port: 5432

  - name: kafka
    namespace: services
    chart: bitnami/kafka
    version: 26.8.2
    values:
      - kraft:
          enabled: false
        zookeeper:
          enabled: true
          replicaCount: 1
        controller:
          replicaCount: 0
        broker:
          replicaCount: 3
        listeners:
          client:
            protocol: PLAINTEXT
        auth:
          enabled: false
        service:
          port: 9092

  - name: keycloak
    namespace: oauth-apps
    chart: bitnami/keycloak
    version: 21.2.1
    values:
      - auth:
          adminUser: admin
          adminPassword: admin
        replicaCount: 1
        resources:
          requests:
            memory: 3Gi
            cpu: 500m
          limits:
            memory: 3Gi
            cpu: 1000m
        service:
          type: ClusterIP
        ingress:
          enabled: false
          
  - name: oauth-client
    chart: ./rails-app
    namespace: oauth-apps
    values:
      - values/values-client.yaml
  
  - name: oauth-client-kafka
    chart: ./rails-app
    namespace: oauth-apps
    values:
      - values/values-client-kafka.yaml

  - name: oauth-idp
    chart: ./rails-app
    namespace: oauth-apps
    values:
      - values/values-idp.yaml

  - name: tls-secret
    chart: ./tls-secret
    namespace: oauth-apps